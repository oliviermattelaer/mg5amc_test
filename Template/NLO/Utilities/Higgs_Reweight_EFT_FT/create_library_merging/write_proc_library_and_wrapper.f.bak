      program write_proc_labels_virtual
      implicit none
      character*200 procid,str_j,str_mult,str_temp,library,line
      character*1 s1
      character*2 s2
      character*3 s3
      character*60 buff,model
      integer maxproc,maxpart
      parameter (maxproc=999,maxpart=20)
      integer total_proc,i,j,proc_number(maxproc),npart(maxproc),
     &     partid(maxpart,maxproc),lstr(maxproc),l,iproc,mult
      character*140 str(maxproc)
      character*2 ls
      logical need_switching
      integer date(3),time(3),len_line
      integer flst_ml5(maxproc),k,alpha(maxproc),alphas(maxproc)
      
      model='sm'
      library='ML5lib_reweight'

      open (unit=11,file='processes.dat',status='old',err=33)
      i = 0
      iproc = 0
 100  i = i + 1
      read(11,*,END=101) line
      if ((line(1:1).eq.' ').or.(line(1:1).eq.'#')) then
         GOTO 100
      endif
      iproc = iproc+1
      backspace(11)
      read(11,*,err=33) proc_number(iproc),npart(iproc),
     &     (partid(j,iproc),j=1,npart(iproc)),alpha(iproc),alphas(iproc)
      total_proc=proc_number(iproc)
      GOTO 100
 101  close(11)
c$$$      print*,'total processes',total_proc
c$$$      do j=1,total_proc
c$$$         print*, 'npart (',j,')',npart(j)
c$$$         do k=1,npart(j)
c$$$            flst_ml5(k)=partid(k,j)
c$$$            if (flst_ml5(k).eq.0) flst_ml5(k)=21
c$$$         enddo
c$$$         print*, 'partid(',j,')',(flst_ml5(k),k=1,npart(j))
c$$$      enddo
c$$$      print*, 'alpha  1-4',alpha(1),alpha(2),alpha(3),alpha(4)
c$$$      print*, 'alphas 1-4',alphas(1),alphas(2),alphas(3),alphas(4)


      open(unit=18,file='MadLoop.mg5',err=35)
      open(unit=12,file='loop_matrix_lib.f',status='unknown')
      write(*,*) '************************************************'//
     $     '******'
      write(*,*) 'Writing the orderfile for MadLoop5...'
      write(*,*) 'and a wrapper function to access the library...'
      write(*,*) ''
       

      write(18,*) '# MadLoop.mg5'
      write(18,*) '# Created for heft-mergin + reweighting'
      write(18,*)
      write(18,*) 'import model loop_'//model
      write (12,*) 
     f '     subroutine loop_matrix_lib(procid,P0,P1,P2,HEL,ANS)'
      write (12,*) '     implicit none'
      write (12,*) '     character*200 procid'
      write (12,*) '     integer HEL'
      write (12,*) '     INCLUDE "nsquaredSO.inc"'
      write (12,*) '     double precision P0(0:3,3),P1(0:3,4),P2(0:3,5)'
      write (12,*) '    f     ,ANS(0:3,0:NSQUAREDSO)'
      write (12,*) '     '
      do j=1,total_proc
         do k=1,npart(j)
            flst_ml5(k)=partid(k,j)
            if (flst_ml5(k).eq.0) flst_ml5(k)=21
         enddo
         write(18,*) 'add process '
     $        ,(flst_ml5(k),k=1,2),' >', (flst_ml5(k),k=3,npart(j))
     $        ,' QED=',alpha(j),' QCD=',alphas(j)-1,' [virt=QCD] @ ',j
         procid=""
         do k=1,npart(j)
            write(str_temp,*) flst_ml5(k)
            procid = trim(adjustl(procid))//' '//trim(adjustl(str_temp))
         enddo
!         print*, procid

      write(str_j,*) j
      write(str_mult,*) npart(j)-3
      write (12,*) '     if(procid .eq. "',trim(procid),'") then'
      write (12,*) '         call ML5_',trim(adjustl(str_j))
     f ,'_SLOOPMATRIXHEL(P',trim(adjustl(str_mult)),',HEL,ANS)'
      write (12,*) '     endif'

      enddo
      write(18,*) 'output ',trim(adjustl(library))
      write(18,*) 'launch -f'
      write (12,*) '     '
      write (12,*) '     return'
      write (12,*) '     end'
      write (12,*) '     '
      close(18)
      close(12)


      call system("../bin/mg5_aMC MadLoop.mg5")
      call system("cp loop_matrix_lib.f "
     f     //trim(adjustl(library))//"/SubProcesses/")
      call system("mv "//trim(adjustl(library))//
     f     "/SubProcesses/makefile "//trim(adjustl(library))//
     f     "/SubProcesses/makefile_orig")
      call system("cp "//trim(adjustl(library))//
     f "/SubProcesses/P1_gg_h/nsquaredSO.inc "//trim(adjustl(library))//
     f  "/SubProcesses/")

      open (unit=20,file=trim(adjustl(library))//
     f     "/SubProcesses/makefile_orig",status='old',err=43)
      open(unit=21,file=trim(adjustl(library))//
     f     "/SubProcesses/makefile",err=44)
      i = 0
      iproc = 0
 200  i = i + 1
      read(20,10,END=201) line
      if (line(1:11).eq.'OLP_PROCESS') then
         len_line=LEN(TRIM(line))
         line=line(1:len_line-2)//" loop_matrix_lib.f \ "
      endif
      write(21,10) trim(line)
      GOTO 200
 201  close(20)
      close(21)


      return
 32   write (*,*)
     &     "ERROR: file 'proc_number' not found or not correct format."
      return
 33   write (*,*)
     &    "ERROR: file 'processes.dat' not found or not correct format."
 34   write (*,*)
     &  "ERROR: file 'proc_couplings' not found or not correct format."
      return
 35   write(*,*) '******************************************'
      write(*,*) 'Problem in writing the order file'
      write(*,*) 'CANNOT PROCEED. POWHEG execution abort'
      write(*,*) '******************************************'
      return
 36   write (*,*) "ERROR: file 'proc_couplings'"/
     $     /" not found or not correct format."
      return
 37   write (*,*) "ERROR: file '../Cards/proc_card.dat'"/
     $     /" not found or not correct format."
      return
 43   write (*,*)
     &    "ERROR: file '"//trim(adjustl(library))//"/SubProcesses/"//
     f     "makefile_orig' not found or not correct format."
 44   write (*,*)
     &    "ERROR: file '"//trim(adjustl(library))//"/SubProcesses/"//
     f     "makefile' not found or not correct format."
 10   format(A)
      end

